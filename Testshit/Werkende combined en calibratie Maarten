#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_BNO055.h>
#include <utility/imumaths.h>
#include <Arduino.h>
#include <SoftwareSerial.h>

#define ENCA 3 // YELLOW
#define ENCB 2 // WHITE
#define PWM 5
#define IN2 6
#define IN1 7

#define BNO055_SAMPLERATE_DELAY_MS (10)

Adafruit_BNO055 bno = Adafruit_BNO055(-1, 0x28, &Wire);

float euler_offset_y = -6.06;
float euler_offset_z = 5.69;

void setup(void)
{
  Serial.begin(230400);
  while (!Serial) delay(10);

  if(!bno.begin())
  {
    while(1);
  }

  bno.setExtCrystalUse(true);

  pinMode(ENCA, INPUT);
  pinMode(ENCB, INPUT);
  pinMode(PWM, OUTPUT);
  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);

  // Calibrate the sensor before proceeding
  calibrateSensor();
}

void loop(void)
{
  imu::Vector<3> euler = bno.getVector(Adafruit_BNO055::VECTOR_EULER);
  imu::Vector<3> gyr = bno.getVector(Adafruit_BNO055::VECTOR_GYROSCOPE);

  float euler_y = euler.y() - euler_offset_y;
  float euler_z = euler.z() - euler_offset_z;
  
  Serial.print(euler_y);
  Serial.print(",");
  Serial.print(euler_z);
  Serial.print(",");
  Serial.print(gyr.y());
  Serial.print(",");
  Serial.println(gyr.z());
  delay(100);

  if (Serial.available() > 0) {
    int pps = Serial.readStringUntil(0x0a).toInt();
    int dir = (pps < 0) ? -1 : (pps > 0) ? 1 : 0;
    pps = abs(pps);

    setMotor(dir, pps, PWM, IN1, IN2);
  }
}

void setMotor(int dir, int motor_value, int pwm, int in1, int in2)
{
  analogWrite(pwm, motor_value);
  if (dir == 1) {
    digitalWrite(in1, HIGH);
    digitalWrite(in2, LOW);
  } else if (dir == -1) {
    digitalWrite(in1, LOW);
    digitalWrite(in2, HIGH);
  } else {
    digitalWrite(in1, LOW);
    digitalWrite(in2, LOW);
  }
}

void calibrateSensor()
{
  uint8_t system, gyro, accel, mag;
  system = gyro = accel = mag = 0;

  while (system != 3 || gyro != 3 || accel != 3 || mag != 3)
  {
    bno.getCalibration(&system, &gyro, &accel, &mag);
    Serial.print("CALIBRATION: Sys=");
    Serial.print(system, DEC);
    Serial.print(" Gyro=");
    Serial.print(gyro, DEC);
    Serial.print(" Accel=");
    Serial.print(accel, DEC);
    Serial.print(" Mag=");
    Serial.println(mag, DEC);
    delay(500);
  }
  Serial.println("Calibration complete!");
}
